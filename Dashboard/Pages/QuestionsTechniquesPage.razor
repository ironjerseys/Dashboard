@page "/quiz"

@using System.Net
@using System.Text.RegularExpressions
@using Dashboard.Components.Quiz
@using Dashboard.Persistance.Entities
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using global::Dashboard.Persistance.Entities
@using global::Dashboard.Services

@inject IDbQuizService QuizService
@inject IArticleService ArticleService

@rendermode RenderMode.InteractiveServer

<div class="container mt-4">
    <div class="card p-3 text-white"
         style="background: rgba(20,20,22,.88); border-radius: 18px; border: 1px solid rgba(255,255,255,.12); backdrop-filter: blur(10px);">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="m-0">Quiz</h4>

            <div class="d-flex align-items-center gap-2">
                <div class="text-white-50 small">Score : @_score / @_questions.Count</div>
                @* <button type="button" class="btn btn-sm btn-outline-light" @onclick="OpenCreateQuestion">
                    <i class="bi bi-plus-lg"></i> Question
                </button> *@
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(_errorMessage))
        {
            <div class="alert alert-danger">@_errorMessage</div>
        }

        @if (_isLoading)
        {
            <div class="text-muted">Chargement…</div>
        }
        else if (_questions.Count == 0)
        {
            <div class="alert alert-warning mb-0">Aucune question.</div>
        }
        else if (_currentIndex >= _questions.Count)
        {
            <h5>Quiz terminé</h5>
            <p>Votre score : <strong>@_score</strong> / <strong>@_questions.Count</strong></p>

            <div class="d-flex gap-2">
                <button type="button" class="btn btn-info" @onclick="Restart">Recommencer</button>
                <a class="btn btn-secondary" href="/dashboard">Retour Dashboard</a>
            </div>
        }
        else
        {
            var currentQuestion = _questions[_currentIndex];
            var choices = GetChoices(currentQuestion);

            var qHtml = currentQuestion.QuestionText ?? "";
            var qPlain = ToPlainText(qHtml);

            <h6 class="mb-2">Question @(_currentIndex + 1) sur @_questions.Count</h6>

            @* Affichage question : code fence -> <pre>, sinon HTML Summernote -> MarkupString, sinon texte *@
            @if (HasCodeFence(qPlain))
            {
                <pre class="mb-3 p-3"
                     style="background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.10); border-radius: 12px; overflow:auto;">
<code>@ExtractCode(qPlain)</code>
</pre>
            }
            else if (LooksLikeHtml(qHtml))
            {
                <div class="mb-3 quiz-html">
                    @((MarkupString)qHtml)
                </div>
            }
            else
            {
                <p class="mb-3">@qHtml</p>
            }

            @if (!_showResult)
            {
                <InputRadioGroup @bind-Value="_selectedChoiceIndex">
                    @for (int i = 0; i < 4; i++)
                    {
                        var inputId = $"q{currentQuestion.Id}_c{i}";
                        <div class="form-check mb-2">
                            <InputRadio class="form-check-input" id="@inputId" Value="@i" />
                            <label class="form-check-label" for="@inputId">@choices[i]</label>
                        </div>
                    }
                </InputRadioGroup>

                <button type="button" class="btn btn-primary mt-3" @onclick="ValidateAnswerAsync">
                    Valider
                </button>
            }
            else
            {
                if (_isCorrect)
                {
                    <p class="text-success fw-semibold">Bonne réponse !</p>
                }
                else
                {
                    <p class="text-danger fw-semibold">
                        Mauvaise réponse. La bonne réponse était : @choices[currentQuestion.CorrectAnswer]
                    </p>
                }

                var eHtml = currentQuestion.Explanation ?? "";

                <div class="mt-2">
                    <strong>Explication :</strong>

                    @if (LooksLikeHtml(eHtml))
                    {
                        <div class="mt-1 quiz-html">
                            @((MarkupString)eHtml)
                        </div>
                    }
                    else
                    {
                        <div class="mt-1">@eHtml</div>
                    }
                </div>

                <button type="button" class="btn btn-primary mt-3" @onclick="Next">
                    Suivant
                </button>
            }
        }
    </div>
</div>

<style>
    .quiz-html p { margin-bottom: .5rem; }
</style>

@code {
    private bool _isLoading;
    private string? _errorMessage;

    private List<QuestionTechnique> _questions = new();
    private int _currentIndex;
    private int _score;

    private bool _showResult;
    private bool _isCorrect;
    private int? _selectedChoiceIndex;

    // (garde si tu veux réactiver la création plus tard)
    private bool _createQuestionOpen;
    private bool _createBusy;
    private string? _createError;

    private QuestionTechnique _createModel = new();
    private List<Article> _articles = new();

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;
        _errorMessage = null;

        try
        {
            _questions = (await QuizService.GetQuestionsAsync()).ToList();
            // _articles = (await ArticleService.GetArticlesAsync(sort: ArticleSort.DateNewest)).ToList();

            Restart();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task ReloadQuestionsAsync()
    {
        var previousIndex = _currentIndex;
        var previousScore = _score;

        _questions = (await QuizService.GetQuestionsAsync()).ToList();

        _currentIndex = Math.Min(previousIndex, Math.Max(_questions.Count - 1, 0));
        _score = previousScore;

        StateHasChanged();
    }

    private Task ValidateAnswerAsync()
    {
        _errorMessage = null;

        if (_currentIndex >= _questions.Count)
            return Task.CompletedTask;

        if (!_selectedChoiceIndex.HasValue)
        {
            _errorMessage = "Choisissez une réponse.";
            return Task.CompletedTask;
        }

        var q = _questions[_currentIndex];
        _isCorrect = (_selectedChoiceIndex.Value == q.CorrectAnswer);

        if (_isCorrect)
            _score++;

        _showResult = true;
        return Task.CompletedTask;
    }

    private void Next()
    {
        _currentIndex++;
        _showResult = false;
        _isCorrect = false;
        _selectedChoiceIndex = null;
    }

    private void Restart()
    {
        _currentIndex = 0;
        _score = 0;
        _showResult = false;
        _isCorrect = false;
        _selectedChoiceIndex = null;
        _errorMessage = null;
    }

    private static string[] GetChoices(QuestionTechnique q)
        => new[] { q.Choice0, q.Choice1, q.Choice2, q.Choice3 };

    private static bool LooksLikeHtml(string? s)
    {
        if (string.IsNullOrWhiteSpace(s)) return false;

        return s.Contains("<p", StringComparison.OrdinalIgnoreCase)
            || s.Contains("<br", StringComparison.OrdinalIgnoreCase)
            || s.Contains("<div", StringComparison.OrdinalIgnoreCase)
            || s.Contains("<span", StringComparison.OrdinalIgnoreCase)
            || s.Contains("<pre", StringComparison.OrdinalIgnoreCase)
            || s.Contains("<code", StringComparison.OrdinalIgnoreCase)
            || s.Contains("<img", StringComparison.OrdinalIgnoreCase);
    }

    private static string ToPlainText(string? html)
    {
        if (string.IsNullOrWhiteSpace(html)) return string.Empty;

        var s = html
            .Replace("<br>", "\n", StringComparison.OrdinalIgnoreCase)
            .Replace("<br/>", "\n", StringComparison.OrdinalIgnoreCase)
            .Replace("<br />", "\n", StringComparison.OrdinalIgnoreCase)
            .Replace("</p>", "\n", StringComparison.OrdinalIgnoreCase);

        s = Regex.Replace(s, "<.*?>", string.Empty);
        return WebUtility.HtmlDecode(s);
    }

    private static bool HasCodeFence(string? text)
        => !string.IsNullOrEmpty(text) && text.Contains("```", StringComparison.Ordinal);

    private static string ExtractCode(string? text)
    {
        text ??= string.Empty;

        int start = text.IndexOf("```", StringComparison.Ordinal);
        int end = text.LastIndexOf("```", StringComparison.Ordinal);

        if (start >= 0 && end > start)
            return text.Substring(start + 3, end - start - 3).Trim();

        return text.Trim();
    }
}
