@page "/articles/{Id:int}"

@rendermode RenderMode.InteractiveServer

@using Dashboard.Components.Quiz
@using Dashboard.Persistance.Entities
@using Dashboard.Persistance.Entities.Enums
@using Dashboard.Persistance.Entities
@using Dashboard.Persistance.Entities.Enums
@using Dashboard.Services
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web


@inject IArticleService ArticleService
@inject IDbQuizService QuizService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation

@if (_isLoading)
{
    <p class="mt-4">Chargement…</p>
}
else if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger mt-4">@_error</div>
}
else if (_article is null || _notFound)
{
    <div class="container mt-5 article-page">
        <div class="alert alert-warning">Article introuvable.</div>
        <a class="btn btn-secondary" href="/articles-v2">Retour à la liste</a>
    </div>
}
else
{
    <div class="container mt-5 mb-5 article-page">
        <div class="mb-5 article-content card p-3">
            <div class="d-flex align-items-center gap-2 flex-nowrap overflow-auto pb-2 mb-2">
                @if (_isAdmin)
                {
                    <a class="btn btn-secondary" href="@($"/articles/edit/{_article.Id}")" title="Modifier">
                        <i class="bi bi-pencil"></i>
                    </a>

                    <button class="btn btn-secondary" type="button" @onclick="OpenDeleteConfirm" title="Supprimer">
                        <i class="bi bi-trash"></i>
                    </button>

                    <button type="button" class="btn btn-outline-light" @onclick="OpenCreateQuestion">
                        Ajouter une question liée
                    </button>
                }

                <a class="btn btn-secondary ms-auto" href="/articles">Retour à la liste</a>
            </div>

            <div class="d-flex flex-column flex-md-row gap-2 mt-2">
                <div class="flex-grow-1 d-flex align-items-center">
                    <h2 class="mt-3">@_article.Titre</h2>
                </div>
            </div>

            @if (_article.Labels?.Any() ?? false)
            {
                <div class="mt-3 mb-3">
                    <span class="bb-text-orange">Labels:</span>
                    @foreach (var label in _article.Labels)
                    {
                        <span class="bb-text-cyan">@label.Name</span>
                    }
                </div>
            }

            <div class="small text-muted mt-2 mb-5">
                Publié le @_article.DateCreation.ToLocalTime().ToString("yyyy-MM-dd HH:mm")
            </div>

            @((MarkupString)(_article.Contenu ?? string.Empty))

            @if (_questions.Count > 0)
            {
                <div class="card p-3 mb-3">
                    <h5>Questions liées</h5>
                    <ul class="mb-0">
                        @foreach (var question in _questions)
                        {
                            <li>@question.QuestionText</li>
                        }
                    </ul>
                </div>
            }
        </div>
    </div>
}


<Dashboard.Components.Dashboard.ConfirmModal IsOpen="_showDeleteConfirm"
                                             IsOpenChanged="OnDeleteModalChanged"
                                             Title="Supprimer l’article"
                                             Message="Cette action est définitive. Voulez-vous vraiment supprimer cet article ?"
                                             ConfirmLabel="Supprimer"
                                             Busy="_isDeleting"
                                             OnConfirm="DeleteConfirmedAsync" />

<Dashboard.Components.Quiz.QuizQuestionEditorModal IsOpen="_createQuestionOpen"
                                                   IsOpenChanged="OnCreateQuestionOpenChanged"
                                                   Title="Créer une question"
                                                   SubmitLabel="Créer"
                                                   Busy="_createBusy"
                                                   Error="_createError"
                                                   Model="_createModel"
                                                   Articles="_allArticles"
                                                   OnSubmit="CreateQuestionAsync" />



@code {
    [Parameter] public int Id { get; set; }

    private bool _isLoading = true;
    private string? _error;
    private string? _errorMessage;


    private Article? _article;
    private List<QuestionTechnique> _questions = new();

    private bool _isAdmin;
    private bool _notFound;

    private bool _showDeleteConfirm;
    private bool _isDeleting;
    private string? _deleteError;

    private bool _createQuestionOpen;

    private bool _createBusy;
    private string? _createError;
    private QuestionTechnique _createModel = new() { CorrectAnswer = 0 };
    private List<Article> _allArticles = new();


    protected override async Task OnParametersSetAsync()
    {
        _isLoading = true;
        _error = null;
        _notFound = false;
        _article = null;
        _questions = new();

        try
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            _isAdmin = authState.User.IsInRole("Admin");

            _article = await ArticleService.GetArticleAsync(Id);

            if (_article is null)
            {
                _notFound = true;
                return;
            }

            if (!_isAdmin && !_article.IsPublic)
            {
                _notFound = true;
                _article = null;
                return;
            }
            if (_allArticles.Count == 0)
            {
                var all = await ArticleService.GetArticlesAsync(sort: ArticleSort.DateNewest);
                _allArticles = all.ToList();
            }
            _questions = await QuizService.GetByArticleAsync(Id);
        }
        catch (Exception exception)
        {
            _error = exception.Message;
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void OpenDeleteConfirm()
    {
        _deleteError = null;
        _showDeleteConfirm = true;
    }

    private Task OnDeleteModalChanged(bool isOpen)
    {
        _showDeleteConfirm = isOpen;
        return Task.CompletedTask;
    }

    private async Task DeleteConfirmedAsync()
    {
        if (_article is null) return;

        _isDeleting = true;
        _deleteError = null;

        try
        {
            await ArticleService.DeleteAsync(_article.Id);

            _showDeleteConfirm = false;
            Navigation.NavigateTo("/articles");
        }
        catch (Exception ex)
        {
            _deleteError = ex.Message;
        }
        finally
        {
            _isDeleting = false;
        }
    }

    private void OpenCreateQuestion()
    {
        _createError = null;
        _createModel = new QuestionTechnique
        {
            ArticleId = Id,
            CorrectAnswer = 0
        };
        _createQuestionOpen = true;
    }

    private Task OnCreateQuestionOpenChanged(bool isOpen)
    {
        _createQuestionOpen = isOpen;
        return Task.CompletedTask;
    }

    private async Task ReloadQuestions()
    {
        try
        {
            _errorMessage = null;

            // recharge uniquement les questions liées à cet article
            _questions = await QuizService.GetByArticleAsync(Id);

            _createQuestionOpen = false;

            StateHasChanged();
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
            StateHasChanged();
        }
    }

    private async Task CreateQuestionAsync(QuestionTechnique questionTechnique)
    {
        _createBusy = true;
        _createError = null;

        try
        {
            await QuizService.CreateAsync(questionTechnique);
            await ReloadQuestions();
            _createQuestionOpen = false;
        }
        catch (Exception ex)
        {
            _createError = ex.Message;
        }
        finally
        {
            _createBusy = false;
        }
    }

}
