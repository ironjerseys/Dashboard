@page "/quiz/questions"
@attribute [Microsoft.AspNetCore.Authorization.Authorize(Roles = "Admin")]

@using Dashboard.Entities
@using Dashboard.Entities.Enums
@using Dashboard.Services

@using Microsoft.AspNetCore.Components.Web
@rendermode RenderMode.InteractiveServer

@inject IDbQuizService QuizService
@inject IArticleService ArticleService

@using Dashboard.Components.Quiz
@using Dashboard.Components.Dashboard

<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h1 class="mb-0">Questions techniques</h1>
            <div class="text-muted">Gestion des questions</div>
        </div>

        <button class="btn btn-primary" @onclick="OpenCreateModal" disabled="@_busy">
            + Nouvelle question
        </button>
    </div>
    @if (!string.IsNullOrWhiteSpace(_pageError))
    {
        <div class="alert alert-danger">@_pageError</div>
    }
    <div class="table-responsive">

        @foreach (QuestionTechnique question in _questions)
        {
            <div class="card p-3 mb-3">
                <div class="d-flex justify-content-between gap-3 flex-wrap">
                    <div class="flex-grow-1">

                        <div class="fw-semibold mb-2">
                            @question.QuestionText
                        </div>

                        <ol class="mb-2 ps-3">
                            <li class="@(question.CorrectAnswer == 0 ? "text-success fw-semibold" : "")">
                                @question.Choice0
                            </li>
                            <li class="@(question.CorrectAnswer == 1 ? "text-success fw-semibold" : "")">
                                @question.Choice1
                            </li>
                            <li class="@(question.CorrectAnswer == 2 ? "text-success fw-semibold" : "")">
                                @question.Choice2
                            </li>
                            <li class="@(question.CorrectAnswer == 3 ? "text-success fw-semibold" : "")">
                                @question.Choice3
                            </li>
                        </ol>

                        <div class="small text-muted">
                            Bonne réponse : <strong>@(question.CorrectAnswer + 1)</strong>
                            <span class="mx-2">•</span>
                            Article :
                            @if (question.ArticleId.HasValue)
                            {
                                <span>
                                    @(question.Article is not null ? question.Article.Titre : $"Article #{question.ArticleId.Value}")
                                </span>
                            }
                            else
                            {
                                <span>—</span>
                            }
                        </div>
                    </div>

                    <div class="d-flex gap-2 align-items-start">
                        <button class="btn"
                                title="Modifier"
                                @onclick="() => OpenEditModal(question)"
                                disabled="@_busy">
                            <i class="bi bi-pencil"></i>
                        </button>

                        <button class="btn"
                                title="Supprimer"
                                @onclick="() => AskDelete(question)"
                                disabled="@_busy">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<QuizQuestionEditorModal IsOpen="_editorOpen"
                         IsOpenChanged="OnEditorOpenChanged"
                         Title="@_editorTitle"
                         SubmitLabel="@_editorSubmitLabel"
                         Busy="_busy"
                         Error="_editorError"
                         Model="_editorModel"
                         Articles="_articles"
                         OnSubmit="SaveQuestionAsync" />

<ConfirmModal IsOpen="_deleteConfirmOpen"
              IsOpenChanged="OnDeleteConfirmOpenChanged"
              Title="Supprimer la question"
              Message="@_deleteMessage"
              ConfirmLabel="Supprimer"
              Busy="_busy"
              OnConfirm="DeleteConfirmedAsync" />

<style>
    /* Lisibilité : bordures discrètes + colonnes visibles */
    .quiz-table {
        border-radius: 12px;
        overflow: hidden;
    }

    .quiz-thead th {
        font-weight: 600;
        white-space: nowrap;
    }

    /* Bordures plus discrètes (surtout utile si ton thème est sombre) */
    .quiz-table.table-bordered > :not(caption) > * > * {
        border-color: rgba(255,255,255,.10);
    }

    /* Cellules lisibles, sans casser toute la table */
    .cell-wrap {
        white-space: pre-wrap;
        word-break: break-word;
        line-height: 1.25rem;
    }

    /* Largeurs (ajuste si besoin) */
    .col-question {
        min-width: 320px;
    }

    .col-choice {
        min-width: 220px;
    }

    .col-article {
        min-width: 200px;
    }

    .col-correct {
        width: 80px;
    }

    .col-action {
        width: 100px;
    }

    /* Un peu d’air */
    .quiz-table td, .quiz-table th {
        padding: .6rem .6rem;
        vertical-align: top;
    }
</style>

@code {
    private List<QuestionTechnique> _questions = new();
    private List<Article> _articles = new();

    private bool _busy;
    private string? _pageError;

    // Editor modal
    private bool _editorOpen;
    private string _editorTitle = "Nouvelle question";
    private string _editorSubmitLabel = "Créer";
    private string? _editorError;
    private QuestionTechnique _editorModel = new();
    private bool _isEditMode;

    // Delete confirm
    private bool _deleteConfirmOpen;
    private int _deleteQuestionId;
    private string _deleteMessage = "";

    protected override async Task OnInitializedAsync()
    {
        await ReloadAsync();
    }

    private async Task ReloadAsync()
    {
        _pageError = null;
        _editorError = null;

        try
        {
            _busy = true;

            _questions = await QuizService.GetQuestionsAsync();
            _articles = (await ArticleService.GetArticlesAsync(sort: ArticleSort.DateNewest)).ToList();
        }
        catch (Exception ex)
        {
            _pageError = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private void OpenCreateModal()
    {
        _isEditMode = false;
        _editorTitle = "Nouvelle question";
        _editorSubmitLabel = "Créer";
        _editorError = null;

        _editorModel = new QuestionTechnique
        {
            CorrectAnswer = 0
        };

        _editorOpen = true;
    }

    private void OpenEditModal(QuestionTechnique question)
    {
        _isEditMode = true;
        _editorTitle = "Modifier la question";
        _editorSubmitLabel = "Enregistrer";
        _editorError = null;

        _editorModel = new QuestionTechnique
        {
            Id = question.Id,
            QuestionText = question.QuestionText,
            Choice0 = question.Choice0,
            Choice1 = question.Choice1,
            Choice2 = question.Choice2,
            Choice3 = question.Choice3,
            CorrectAnswer = question.CorrectAnswer,
            Explanation = question.Explanation,
            ArticleId = question.ArticleId
        };

        _editorOpen = true;
    }

    private Task OnEditorOpenChanged(bool open)
    {
        _editorOpen = open;
        return Task.CompletedTask;
    }

    private async Task SaveQuestionAsync(QuestionTechnique model)
    {
        _editorError = null;

        try
        {
            _busy = true;

            if (_isEditMode)
            {
                bool ok = await QuizService.UpdateAsync(model);
                if (!ok)
                {
                    _editorError = "Question introuvable (elle a peut-être été supprimée).";
                    return;
                }
            }
            else
            {
                await QuizService.CreateAsync(model);
            }

            _editorOpen = false;
            await ReloadAsync();
        }
        catch (Exception ex)
        {
            _editorError = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private void AskDelete(QuestionTechnique question)
    {
        _deleteQuestionId = question.Id;
        string preview = MakePreview(question.QuestionText, 90);
        _deleteMessage = $"Supprimer cette question ?\n\n\"{preview}\"\n\nCette action est définitive.";
        _deleteConfirmOpen = true;
    }

    private Task OnDeleteConfirmOpenChanged(bool open)
    {
        _deleteConfirmOpen = open;
        return Task.CompletedTask;
    }

    private async Task DeleteConfirmedAsync()
    {
        try
        {
            _busy = true;

            await QuizService.DeleteAsync(_deleteQuestionId);

            _deleteConfirmOpen = false;
            await ReloadAsync();
        }
        catch (Exception ex)
        {
            _pageError = ex.Message;
        }
        finally
        {
            _busy = false;
        }
    }

    private static string MakePreview(string? text, int maxChars)
    {
        if (string.IsNullOrWhiteSpace(text))
        {
            return "";
        }

        string normalized = text.Replace("\r", " ").Replace("\n", " ").Trim();
        if (normalized.Length <= maxChars)
        {
            return normalized;
        }

        return normalized[..maxChars].TrimEnd() + "…";
    }
}
