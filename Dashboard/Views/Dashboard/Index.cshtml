@model Dashboard.Models.DashboardPageViewModel
@using Microsoft.AspNetCore.Mvc.Rendering
@{
    int year = Model.Year;
    int month = Model.Month;
    var selected = Model.SelectedGoal;
}

<h1 class="m-3">Dashboard</h1>

<!-- Ligne 1: Calendrier (2/3) + Todo (1/3) -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="calendar">
            <div class="d-flex justify-content-between align-items-center mb-2 px-2 py-1 bg-primary text-white rounded">
                <div class="d-flex align-items-center gap-2">
                    <a class="btn btn-sm fw-bold fs-5" asp-route-year="@(month==1?year-1:year)" asp-route-month="@(month==1?12:month-1)">«</a>
                    <strong class="fs-5">@(new DateTime(year, month, 1).ToString("MMMM yyyy"))</strong>
                    <a class="btn btn-sm fw-bold fs-5" asp-route-year="@(month==12?year+1:year)" asp-route-month="@(month==12?1:month+1)">»</a>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered calendar text-center align-middle mb-0" style="table-layout: fixed;">
                    <thead class="bg-transparent">
                        <tr>
                            <th>Lun</th><th>Mar</th><th>Mer</th><th>Jeu</th><th>Ven</th><th>Sam</th><th>Dim</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var row in Model.CalendarRows)
                    {
                        <tr>
                            @foreach (var cell in row)
                            {
                                if (cell.Date == null)
                                {
                                    <td class="bg-light"></td>
                                }
                                else
                                {
                                    <td class="p-1 @cell.CssClass" style="@cell.Style">
                                        <div>@cell.DayNumber</div>
                                    </td>
                                }
                            }
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="p-3 border rounded h-100">
            <h5 class="mb-3">Todo</h5>
            <form id="todo-form" class="mb-3">
                <div class="input-group">
                    <input name="description" id="todo-desc" class="form-control" placeholder="Nouvelle tâche" maxlength="500" required />
                    <button class="btn btn-primary" type="submit">+</button>
                </div>
            </form>
            <ul id="todo-list" class="list-group">
                @foreach (var t in Model.Todos)
                {
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-transparent" data-id="@t.Id">
                        <span style="color: white">@t.Description</span>
                  
                        <div class="btn-group btn-group-sm">
                            <a class="btn btn-outline-secondary" asp-controller="Todos" asp-action="Details" asp-route-id="@t.Id">Ouvrir</a>
                            <a class="btn btn-outline-secondary" asp-controller="Todos" asp-action="Edit" asp-route-id="@t.Id">✎</a>
                            <button class="btn btn-outline-danger del-btn" type="button">×</button>
                        </div>
                    </li>
                }
            </ul>
        </div>
    </div>
</div>

<!-- Ligne 2: Objectifs + Formulaire -->
<div class="row">
    <div class="col-lg-8 goals">
        <h3>Mes objectifs du mois</h3>
        <table class="table table-hover">
            <thead>
            <tr>
                <th>Début</th>
                <th>Fin</th>
                <th>Titre</th>
                <th>Article</th>
                <th>Fait</th>
                <th></th>
            </tr>
            </thead>
            <tbody>
            @foreach (var g in Model.Goals)
            {
                <tr class="@(selected?.Id==g.Id?"table-primary":"")" style="cursor:pointer"
                    onclick="window.location='@Url.Action("Index", new { editGoalId = g.Id, year = year, month = month })'">
                    <td>@g.Debut.ToString("yyyy-MM-dd")</td>
                    <td>@g.Fin.ToString("yyyy-MM-dd")</td>
                    <td>
                        <div class="fw-bold">@g.Titre</div>
                        <div class="text-muted small">@g.Description</div>
                    </td>
                    <td>
                        @if (g.ArticleId.HasValue)
                        {
                            <a asp-controller="Articles" asp-action="Details" asp-route-id="@g.ArticleId">Voir</a>
                        }
                    </td>
                    <td class="text-center">
                        <form asp-controller="Dashboard" asp-action="ToggleDone" method="post" class="d-inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@g.Id" />
                            <button class="btn btn-sm @(g.IsDone ? "btn-success" : "btn-danger")">@(g.IsDone ? "✔" : "✗")</button>
                        </form>
                    </td>
                    <td>
                        <form asp-controller="Dashboard" asp-action="DeleteGoal" method="post" onsubmit="return confirm('Supprimer ?');">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="id" value="@g.Id" />
                            <button class="btn btn-sm btn-outline-danger">Supprimer</button>
                        </form>
                    </td>
                </tr>
            }
            </tbody>
        </table>
    </div>
    <div class="col-lg-4">
        <h3>@(selected==null ? "Nouvel objectif" : "Modifier objectif")</h3>
        <form asp-controller="Dashboard" asp-action="SaveGoal" method="post">
            @Html.AntiForgeryToken()
            @if(selected!=null){<input type="hidden" name="id" value="@selected.Id" />}
            <div class="mb-2">
                <label class="form-label">Titre</label>
                <input name="titre" class="form-control" value="@selected?.Titre" required />
            </div>
            <div class="mb-2">
                <label class="form-label">Description</label>
                <textarea name="description" class="form-control">@selected?.Description</textarea>
            </div>
            <div class="row mb-2">
                <div class="col">
                    <label class="form-label">Début</label>
                    <input type="date" name="debut" class="form-control"
                           value="@(selected?.Debut.ToString("yyyy-MM-dd") ?? DateOnly.FromDateTime(DateTime.Now).ToString("yyyy-MM-dd"))" />
                </div>
                <div class="col">
                    <label class="form-label">Fin</label>
                    <input type="date" name="fin" class="form-control"
                           value="@(selected?.Fin.ToString("yyyy-MM-dd") ?? DateOnly.FromDateTime(DateTime.Now).AddDays(7).ToString("yyyy-MM-dd"))" />
                </div>
            </div>
            <div class="mb-2">
                <label class="form-label">Article (optionnel)</label>
                <select name="articleId" class="form-select" asp-items="(IEnumerable<SelectListItem>)ViewBag.Articles">
                    <option value="">-- Aucun --</option>
                </select>
            </div>
            @if(selected!=null){
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" name="isDone" value="true" @(selected.IsDone?"checked":"") />
                    <label class="form-check-label">Fait</label>
                </div>
            }
            <div class="d-flex gap-2">
                <button class="btn btn-primary flex-grow-1 mt-3">@(selected==null ? "Créer" : "Enregistrer")</button>
                @if(selected!=null){<a class="btn btn-secondary" href="@Url.Action("Index", new { year, month })">Annuler</a>}
            </div>
        </form>
    </div>
</div>

@section Scripts {
<script>
(function(){
 const api = '/api/todo';
 const listEl = document.getElementById('todo-list');
 const form = document.getElementById('todo-form');
 const descInput = document.getElementById('todo-desc');
 form.addEventListener('submit', async e => {
   e.preventDefault();
   const desc = descInput.value.trim();
   if(!desc) return;
   const res = await fetch(api, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ description: desc }) });
   if(res.ok){ descInput.value=''; await reload(); }
 });
 async function reload(){
   const res = await fetch(api);
   if(!res.ok) return;
   const data = await res.json();
   listEl.innerHTML = '';
   for(const t of data){
     const li = document.createElement('li');
     li.className='list-group-item d-flex justify-content-between align-items-center';
     li.dataset.id = t.id;
     li.innerHTML = `<span>${t.description}</span>`+
                    `<div class='btn-group btn-group-sm'>`+
                    `<a class='btn btn-outline-secondary' href='/Todos/Details/${t.id}'>Ouvrir</a>`+
                    `<a class='btn btn-outline-secondary' href='/Todos/Edit/${t.id}'>✎</a>`+
                    `<button class='btn btn-outline-danger del-btn' type='button'>×</button>`+
                    `</div>`;
     listEl.appendChild(li);
   }
 }
 listEl.addEventListener('click', async e => {
   const btn = e.target.closest('button');
   if(!btn) return;
   const li = btn.closest('li');
   const id = li.dataset.id;
   if(btn.classList.contains('del-btn')){
     const ok = confirm('Supprimer ?');
     if(!ok) return;
     const res = await fetch(`${api}/${id}`, { method:'DELETE' });
     if(res.status===204) li.remove();
   }
 });
})();
</script>
}
