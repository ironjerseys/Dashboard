@model IEnumerable<Dashboard.Models.Question>
@using System.Text.Json
@{
    ViewData["Title"] = "Quiz";
}
<link rel="stylesheet" href="~/css/quiz.css" asp-append-version="true" />

<div class="container">
    <div class="item">
        <div id="quiz-root">
            <!-- Le contenu est rendu par le JS ci-dessous -->
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function(){
          // Données passées serveur → client
          const questions = @Html.Raw(JsonSerializer.Serialize(Model));

          let currentQuestionIndex = 0;
          let userScore = 0;
          let showResult = false;
          let isAnswerCorrect = false;

          const root = document.getElementById('quiz-root');

          // Utilitaire: rend un bloc texte ou un bloc code si présence de ```
          function renderQuestionText(container, text){
            container.innerHTML = '';
            if (!text) return;
            if (text.includes('```')) {
              const match = text.match(/```([\s\S]*?)```/);
              if (match) {
                const pre = document.createElement('pre');
                const code = document.createElement('code');
                code.textContent = match[1]; // échappé automatiquement
                pre.appendChild(code);
                container.appendChild(pre);
                return;
              }
            }
            // Sinon, c'est du texte simple: on protège contre l'injection
            const p = document.createElement('p');
            p.textContent = text;
            container.appendChild(p);
          }

          function render(){
            root.innerHTML = '';

            if (!questions || questions.length === 0){
              root.innerHTML = '<p>Aucune question disponible.</p>';
              return;
            }

            if (currentQuestionIndex >= questions.length){
              const h2 = document.createElement('h2');
              h2.textContent = 'Quiz terminé !';
              const p = document.createElement('p');
              p.textContent = `Votre score : ${userScore} / ${questions.length}`;
              const restart = document.createElement('a');
              restart.href = 'javascript:void(0)';
              restart.textContent = 'Recommencer';
              restart.addEventListener('click', () => {
                currentQuestionIndex = 0; userScore = 0; showResult = false; render();
              });
              root.append(h2, p, restart);
              return;
            }

            const q = questions[currentQuestionIndex];

            const h2 = document.createElement('h2');
            h2.textContent = `Question ${currentQuestionIndex + 1} sur ${questions.length}`;
            root.appendChild(h2);

            const questionBlock = document.createElement('div');
            renderQuestionText(questionBlock, q.questionText ?? q.question ?? '');
            root.appendChild(questionBlock);

            // Choix
            (q.choices || []).forEach((choice, i) => {
              const a = document.createElement('a');
              a.href = 'javascript:void(0)';
              a.textContent = choice;
              if (showResult) a.classList.add('disabled');
              a.addEventListener('click', () => {
                if (showResult) return;
                isAnswerCorrect = (i === (q.correctAnswer ?? q.correctanswer));
                if (isAnswerCorrect) userScore++;
                showResult = true;
                render();
              });
              root.appendChild(a);
            });

            // Résultat/explication
            if (showResult){
              const ok = document.createElement('p');
              ok.style.color = isAnswerCorrect ? 'green' : 'red';
              ok.textContent = isAnswerCorrect ? 'Bonne réponse !' : `Mauvaise réponse. La bonne réponse était : ${(q.choices||[])[q.correctAnswer]}.`;
              root.appendChild(ok);

              const expl = document.createElement('p');
              const strong = document.createElement('strong');
              strong.textContent = 'Explication : ';
              expl.appendChild(strong);
              const span = document.createElement('span');
              span.textContent = q.explanation ?? '';
              expl.appendChild(span);
              root.appendChild(expl);

              const next = document.createElement('a');
              next.href = 'javascript:void(0)';
              next.textContent = 'Suivant';
              next.addEventListener('click', () => {
                currentQuestionIndex++;
                showResult = false;
                render();
              });
              root.appendChild(next);
            }
          }

          render();
        })();
    </script>
}